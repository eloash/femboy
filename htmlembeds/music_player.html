<!DOCTYPE html>
<!-- Written by Pekly -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embedded Music Player</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Poppins for clean look, Space Mono for Hacker/Cyberpunk themes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Root Variables (Dynamic Theme Engine) --- */
        :root {
            --background-color: #121212;
            --primary-text: #ffffff;
            --secondary-text: #b3b3b3;
            --highlight-color: #1DB954;
            --border-color: #282828;
            --panel-bg: rgba(25, 20, 20, 0.85);
            --scrollbar-track-color: rgba(0,0,0,0.1);
            --scrollbar-thumb-color: #535353;
            --font-stack: 'Poppins', sans-serif;
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Basic body styling */
        body {
            font-family: var(--font-stack);
            background-color: var(--background-color);
            color: var(--secondary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            transition: background-color 0.4s ease, color 0.4s ease, font-family 0.4s ease;
        }

        /* --- GitHub Promotion Banner --- */
        #github-promotion {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            max-height: 100px;
            overflow: hidden;
            transition: all 0.5s ease-out;
        }
        #github-promotion.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        #github-promotion a { color: var(--primary-text); text-decoration: none; font-weight: 500; }
        #github-promotion a:hover { color: var(--highlight-color); }
        #close-promo-btn { background: none; border: none; color: var(--secondary-text); font-size: 1.2rem; padding: 0; line-height: 1; margin-left: auto; cursor: pointer; }
        #close-promo-btn:hover { color: var(--primary-text); }

        /* --- Custom Cursor --- */
        a, button, .playlist-song, input[type=range] { cursor: pointer; }

        /* --- Player specific styles --- */
        #music-player {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            width: auto;
            z-index: 30;
            display: flex;
            align-items: stretch;
            transition: transform 0.5s var(--ease-out-back);
            border-radius: 8px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            background: transparent;
            justify-content: center;
            font-family: var(--font-stack);
        }

        #music-player.player-hidden {
             transform: translateX(calc(-100% + 42px));
        }
        
        /* Buffering Outline Glow */
        #music-player::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
            z-index: 99;
            box-shadow: 0 0 0 0 var(--highlight-color);
        }
        #music-player.buffering::before {
            opacity: 1;
            animation: buffering-glow 1.5s infinite;
        }

        @keyframes buffering-glow {
            0% { box-shadow: 0 0 3px var(--highlight-color), inset 0 0 3px var(--highlight-color); }
            50% { box-shadow: 0 0 10px var(--highlight-color), inset 0 0 10px var(--highlight-color); }
            100% { box-shadow: 0 0 3px var(--highlight-color), inset 0 0 3px var(--highlight-color); }
        }

        .player-body {
            position: relative;
            padding: 8px;
            width: auto;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-grow: 1;
            overflow: hidden;
            border-radius: 8px 0 0 8px;
            border: 1px solid var(--border-color);
            border-right: none;
            transition: border-color 0.4s ease;
        }

        .player-body::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: -1;
            background: var(--panel-bg);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: inherit;
            transition: background-color 0.4s ease;
        }

        #player-album-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(10px) brightness(0.5);
            z-index: -2;
            transition: background-image 0.5s ease-in-out;
            border-radius: inherit;
        }
        
        #visualizer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.6;
            pointer-events: none;
        }

        .album-art-container {
            position: relative;
            flex-shrink: 0;
            z-index: 1;
        }

        #album-art {
            height: 36px;
            width: 36px;
            border-radius: 50%;
            object-fit: cover;
            transition: transform 0.4s ease-out;
        }

        #playlist-btn {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px; height: 22px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .player-info-and-controls {
            display: flex;
            flex-direction: column;
            gap: 1px;
            width: 100%;
            flex-grow: 1;
            position: relative;
            z-index: 1;
            transition: color 0.4s ease;
        }

        .song-info {
            display: flex;
            align-items: baseline;
            gap: 4px;
            white-space: nowrap;
            overflow: hidden;
        }

        #song-title { font-size: 0.85rem; font-weight: 600; color: var(--primary-text); text-overflow: ellipsis; overflow: hidden; transition: color 0.4s ease; }
        #song-artist { font-size: 0.75rem; color: var(--secondary-text); text-overflow: ellipsis; overflow: hidden; flex-shrink: 1; transition: color 0.4s ease; }

        #player-toggle-btn {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-left: none;
            width: 42px;
            color: var(--primary-text);
            font-size: 1.2rem;
            transition: color 0.2s, text-shadow 0.2s, background-color 0.4s ease, border-color 0.4s ease;
            border-radius: 0 8px 8px 0;
            backdrop-filter: blur(10px) saturate(180%);
            flex-shrink: 0;
            position: relative; /* For canvas positioning */
            z-index: 3;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        #player-toggle-btn i {
             position: relative;
             z-index: 2;
        }

        #player-toggle-btn:hover { color: var(--highlight-color); }
        .toggled-glow { color: var(--highlight-color) !important; }

        .timeline-container { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            width: 100%; 
            position: relative;
        }
        .time-display { font-size: 0.7rem; color: var(--secondary-text); min-width: 32px; text-align: center; transition: color 0.4s ease; }

        .player-controls { display: flex; justify-content: space-between; align-items: center; }
        .player-controls button { background: none; border: none; color: var(--secondary-text); transition: transform 0.2s ease, color 0.4s ease; position: relative; }
        .player-controls button:hover { color: var(--primary-text); transform: scale(1.15); }
        
        #repeat-btn.repeat-one-active::after {
            content: '1';
            position: absolute;
            top: -2px; right: -2px;
            font-size: 0.6rem;
            font-weight: bold;
            color: var(--highlight-color);
        }

        /* Heart Animation */
        #like-btn.liked { color: var(--highlight-color); }
        #like-btn.liked i { animation: heart-pop 0.3s var(--ease-out-back); font-weight: 900; }
        @keyframes heart-pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        
        /* Sleep Timer Active State */
        #sleep-timer-btn.active { color: var(--highlight-color); }
        
        .volume-controls { display: flex; align-items: center; gap: 8px; }

        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; margin: 0; padding: 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #535353; border-radius: 2px; transition: background 0.2s ease; }
        input[type=range]:hover::-webkit-slider-runnable-track { background: var(--highlight-color); }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: var(--primary-text);
            margin-top: -4px;
            opacity: 1;
            cursor: grab;
            transition: transform 0.1s;
        }
        input[type=range].grabbing::-webkit-slider-thumb { cursor: grabbing; transform: scale(1.2); }

        #volume-slider-input { width: 50px; opacity: 1; transition: width 0.3s ease, opacity 0.3s ease; }

        #song-notification-toast {
            position: absolute;
            left: 100%;
            bottom: 0;
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            width: 250px;
            opacity: 0;
            transform: translateY(20px);
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s var(--ease-out-back), visibility 0.4s;
            pointer-events: none;
            backdrop-filter: blur(10px) saturate(180%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            font-family: var(--font-stack);
        }
        #song-notification-toast.show { opacity: 1; transform: translateY(0); visibility: visible; }
        #toast-album-art { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #toast-song-title { font-size: 0.9rem; color: var(--primary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #playlist-modal {
            position: fixed;
            bottom: auto;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 90vw;
            max-width: 400px;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s var(--ease-out-back), visibility 0.4s;
            pointer-events: none;
            font-family: var(--font-stack);
        }
        #playlist-modal.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        .modal-content {
            position: relative;
            border: 1px solid var(--border-color);
            width: 100%;
            max-height: 60vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }
        .modal-content::before { content: ''; position: absolute; inset: 0; z-index: -1; background: var(--panel-bg); backdrop-filter: blur(10px) saturate(180%); border-radius: 8px; }
        .modal-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
        .modal-header-top { display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.2rem; color: var(--primary-text); }
        
        #theme-switcher { display: flex; align-items: center; gap: 6px; }
        .theme-button { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--secondary-text); padding: 0; transition: transform 0.2s ease, border-color 0.2s ease; cursor: pointer; }
        .theme-button:hover { transform: scale(1.1); }
        .theme-button.active { border-color: var(--primary-text); box-shadow: 0 0 5px var(--highlight-color); }

        .search-row { display: flex; gap: 8px; }
        #playlist-search { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary-text); color: var(--primary-text); padding: 5px 8px; font-family: var(--font-stack); border-radius: 4px; box-sizing: border-box; flex-grow: 1; }
        #playlist-search:focus { outline: none; border-color: var(--highlight-color); box-shadow: 0 0 5px var(--highlight-color); }
        
        #filter-fav-btn { background: none; border: 1px solid var(--secondary-text); color: var(--secondary-text); border-radius: 4px; padding: 0 8px; font-size: 0.8rem; transition: all 0.2s; }
        #filter-fav-btn.active { background: var(--highlight-color); color: var(--background-color); border-color: var(--highlight-color); }
        #filter-fav-btn:hover { border-color: var(--highlight-color); }

        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--secondary-text); cursor: pointer; }

        #playlist-container { padding: 5px; overflow-y: auto; flex-grow: 1; }
        #playlist-container::-webkit-scrollbar { width: 8px; }
        #playlist-container::-webkit-scrollbar-track { background: var(--scrollbar-track-color); border-radius: 4px; }
        #playlist-container::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb-color); border-radius: 4px; }
        #playlist-container::-webkit-scrollbar-thumb:hover { background-color: var(--highlight-color); }

        .playlist-song { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 4px; transition: background-color 0.2s; }
        .playlist-song:hover { background-color: rgba(255, 255, 255, 0.1); }
        .playlist-song.playing { background-color: rgba(29, 185, 84, 0.3); } /* Fallback */
        .playlist-song.playing { background-color: var(--highlight-color); color: var(--background-color); } 
        .playlist-song.playing .playlist-song-title { color: inherit; font-weight: bold; }
        .playlist-song.playing .playlist-song-artist { color: inherit; opacity: 0.8; }
        .playlist-song .fav-icon { margin-left: auto; opacity: 0; color: var(--secondary-text); font-size: 0.8rem; transition: opacity 0.2s; }
        .playlist-song:hover .fav-icon, .playlist-song .fav-icon.active { opacity: 1; }
        .playlist-song .fav-icon.active { color: var(--highlight-color); }
        
        .playlist-song img { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover;
            transition: transform 0.4s ease-out;
        }
        .playlist-song-title { font-size: 1rem; color: var(--primary-text); }
        .playlist-song-artist { font-size: 0.9rem; color: var(--secondary-text); }

        .spinning { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        @media (hover: hover) and (pointer: fine) {
            .volume-controls:not(:hover) #volume-slider-input { width: 0; opacity: 0; }
            .album-art-container:not(:hover) #playlist-btn { opacity: 0; }
            #music-player:not(:hover) input[type=range]::-webkit-slider-thumb { opacity: 0; }
        }

        @media (min-width: 768px) {
            #music-player {
                right: auto;
                width: 320px;
                justify-content: flex-start;
            }
            .player-info-and-controls { width: 190px; }
            #playlist-modal {
                position: absolute;
                bottom: 110%;
                top: auto;
                left: 0;
                transform: translateY(10px);
                width: 280px;
            }
             #playlist-modal.show {
                transform: translateY(0);
            }
        }

        @media (min-width: 900px) {
            #music-player {
                bottom: 20px;
                left: 20px;
                width: auto;
            }
            #music-player.player-hidden {
                 transform: translateX(calc(-100% + 50px));
            }
        }
    </style>
</head>
<body>

    <!-- Music Player HTML Structure -->
    <div id="music-player" class="player-hidden">
        <div class="player-body">
            <!-- Canvas is now dynamically added/removed by JS -->
            <div id="player-album-bg"></div>
            <div class="album-art-container">
                <img id="album-art" src="https://placehold.co/40x40/89ddff/0d1126?text=?" alt="Album Art">
                <button id="playlist-btn" title="Playlist" aria-label="Open Playlist"><i class="fas fa-list-ol"></i></button>
            </div>
            <div class="player-info-and-controls">
                <div class="song-info">
                    <span id="song-title">Loading...</span>
                    <span>•</span>
                    <span id="song-artist">Open Source Mix</span>
                </div>
                <div class="timeline-container">
                    <span id="current-time" class="time-display">0:00</span>
                    <input type="range" id="timeline-slider" min="0" max="100" value="0" aria-label="Song progress">
                    <span id="total-duration" class="time-display">0:00</span>
                </div>
                <div class="player-controls">
                    <div class="volume-controls">
                        <button id="volume-btn" title="Volume" aria-label="Mute/Unmute Volume" style="font-size: 0.8rem;"><i class="fas fa-volume-down"></i></button>
                        <input type="range" id="volume-slider-input" min="0" max="1" step="0.01" value="0.2" aria-label="Volume control">
                    </div>
                    <div style="display:flex; align-items:center; gap: 8px;">
                         <button id="like-btn" title="Like Song" aria-label="Like this song" style="font-size: 0.8rem;"><i class="far fa-heart"></i></button>
                        <button id="prev-btn" title="Previous" aria-label="Previous Song" style="font-size: 0.8rem;"><i class="fas fa-backward"></i></button>
                        <button id="play-pause-btn" title="Play/Pause" aria-label="Play or Pause" aria-pressed="false" style="font-size: 1.1rem; color: var(--primary-text);"><i class="fas fa-play"></i></button>
                        <button id="next-btn" title="Next" aria-label="Next Song" style="font-size: 0.8rem;"><i class="fas fa-forward"></i></button>
                        <button id="sleep-timer-btn" title="Sleep Timer" aria-label="Set sleep timer" style="font-size: 0.8rem;"><i class="fas fa-moon"></i></button>
                         <button id="playlist-toggle-btn-main" title="Playlist" aria-label="Open Playlist" style="font-size: 0.8rem;"><i class="fas fa-list-ul"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <button id="player-toggle-btn" title="Toggle Player" aria-label="Show or hide music player">
            <i class="fas fa-music"></i>
        </button>
        <div id="song-notification-toast" role="alert" aria-live="polite">
            <img id="toast-album-art" src="" alt="">
            <div>
                <div style="font-size: 0.8rem; color: var(--secondary-text);">Now Playing:</div>
                <div id="toast-song-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
            </div>
        </div>
        <div id="playlist-modal">
            <div class="modal-content" role="dialog" aria-labelledby="playlist-modal-title">
                <div class="modal-header">
                    <div id="github-promotion">
                        <i class="fab fa-github" aria-hidden="true"></i>
                        <a id="github-link" href="#" target="_blank" rel="noopener noreferrer">Star on GitHub!</a>
                        <button id="close-promo-btn" title="Dismiss" aria-label="Dismiss promotion">&times;</button>
                    </div>

                    <div class="modal-header-top">
                        <h3 id="playlist-modal-title">Playlist</h3>
                         <div id="theme-switcher"></div>
                        <button class="modal-close-btn" aria-label="Close Playlist">&times;</button>
                    </div>
                    <div class="search-row">
                        <input type="text" id="playlist-search" placeholder="Search..." aria-label="Search playlist">
                        <button id="filter-fav-btn" title="Show Favorites Only"><i class="fas fa-heart"></i></button>
                    </div>
                </div>
                <div id="playlist-container"></div>
            </div>
        </div>
    </div>
    <audio id="audio-player" crossOrigin="anonymous"></audio>

    <script>
        // --- Smart Background for Embedding ---
        if (window.self !== window.top) document.body.style.backgroundColor = 'transparent';

        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            const playerConfig = {
                githubUsername: 'Pekly',
                promotionEnabled: true,
                defaultTheme: 'spotify',
                themes: {
                    'spotify': { 
                        name: 'Spotify Dark', 
                        '--background-color': '#121212', 
                        '--primary-text': '#ffffff', 
                        '--secondary-text': '#b3b3b3', 
                        '--highlight-color': '#1DB954', 
                        '--border-color': '#282828', 
                        '--panel-bg': 'rgba(25, 20, 20, 0.85)', 
                        '--scrollbar-track-color': 'rgba(255,255,255,0.1)', 
                        '--scrollbar-thumb-color': '#535353',
                        '--font-stack': "'Poppins', sans-serif"
                    },
                    'light': { 
                        name: 'Arctic Light', 
                        '--background-color': '#f0f2f5', 
                        '--primary-text': '#1c1e21', 
                        '--secondary-text': '#606770', 
                        '--highlight-color': '#0866ff', 
                        '--border-color': '#ced0d4', 
                        '--panel-bg': 'rgba(255, 255, 255, 0.85)', 
                        '--scrollbar-track-color': 'rgba(0,0,0,0.1)', 
                        '--scrollbar-thumb-color': '#b0b3b8',
                        '--font-stack': "'Poppins', sans-serif"
                    },
                    'cyberpunk': { 
                        name: 'Cyberpunk 2077', 
                        '--background-color': '#0b0b0b', 
                        '--primary-text': '#fcee0a', 
                        '--secondary-text': '#00f0ff', 
                        '--highlight-color': '#fcee0a', 
                        '--border-color': '#00f0ff', 
                        '--panel-bg': 'rgba(10, 10, 15, 0.95)', 
                        '--scrollbar-track-color': 'rgba(0,240,255,0.1)', 
                        '--scrollbar-thumb-color': '#fcee0a',
                        '--font-stack': "'Space Mono', monospace"
                    },
                    'sunset': { 
                        name: 'Sunset Blvd', 
                        '--background-color': '#2b102f', 
                        '--primary-text': '#ff9a9e', 
                        '--secondary-text': '#fad0c4', 
                        '--highlight-color': '#ff6b6b', 
                        '--border-color': '#5c3a63', 
                        '--panel-bg': 'rgba(43, 16, 47, 0.9)', 
                        '--scrollbar-track-color': 'rgba(255,154,158,0.1)', 
                        '--scrollbar-thumb-color': '#ff6b6b',
                        '--font-stack': "'Poppins', sans-serif"
                    },
                    'hacker': { 
                        name: 'Hacker Terminal', 
                        '--background-color': '#000000', 
                        '--primary-text': '#00ff00', 
                        '--secondary-text': '#008f11', 
                        '--highlight-color': '#00ff00', 
                        '--border-color': '#003300', 
                        '--panel-bg': 'rgba(0, 0, 0, 0.95)', 
                        '--scrollbar-track-color': '#001100', 
                        '--scrollbar-thumb-color': '#008f11',
                        '--font-stack': "'Space Mono', monospace"
                    }
                }
            };
            
            const playlistData = [
                { title: 'Puppy Girl Anthem', artist: 'Astrid', url: '/audio/DOGGIRL.mp3', albumArtUrl: '/images/albumcover/DOGGIRL.jpg' },
                { title: 'HOUSE', artist: 'WILSON', url: '/audio/Teardrop (Remastered 2019).mp3', albumArtUrl: '/images/housewithtits.png' },
                { title: 'Miku', artist: 'Anamanaguchi', url: 'https://od.lk/s/OTdfOTQ0MDAyODdf/Miku%20by%20Anamanaguchi%20Lyrics%20Video.mp3', albumArtUrl: 'https://t2.genius.com/unsafe/344x344/https%3A%2F%2Fimages.genius.com%2F379dd3f911ddadfb3da8387069fdfd51.1000x1000x1.png' },
                { title: 'Resonance', artist: 'Home', url: 'https://od.lk/s/OTdfOTQzNzY2NjFf/HOME%20Resonance.mp3', albumArtUrl: 'https://f4.bcbits.com/img/a3321951232_10.jpg' },
                { title: 'Memory Reboot', artist: 'VØJ, Narvent', url: 'https://od.lk/s/OTdfOTQzNzY5MjRf/V%C3%98J%20Narvent%20Memory%20Reboot%204K%20Music%20Video.mp3', albumArtUrl: 'https://i1.sndcdn.com/artworks-8zY79hHzgzoNqx9O-qPGziw-t500x500.jpg' },
                { title: 'Pretty Girl', artist: 'Clairo', url: 'https://od.lk/s/OTdfOTQzNzY3Mjlf/Clairo%20Pretty%20Girl%20slowed%20reverb.mp3', albumArtUrl: 'https://t2.genius.com/unsafe/344x344/https%3A%2F%2Fimages.genius.com%2F188096681dc237e27d7f3e8dcb1a9145.1000x1000x1.jpg' },
                { title: 'Cyber City', artist: 'Dystopia', url: 'https://od.lk/s/OTdfOTQ0MDA1NTJf/DVRST%20Dream%20Space.mp3', albumArtUrl: 'https://i1.sndcdn.com/artworks-xBF9BLLAysdb1WLv-oNF5eQ-t1080x1080.jpg' },
                { title: 'Airplane Mode', artist: 'Limbo', url: 'https://od.lk/s/OTdfOTQ0MDA1NDNf/Airplane%20Mode%20Limbo%20Lyrics.mp3', albumArtUrl: 'https://i.scdn.co/image/ab67616d0000b2730b08855f940277500e090ae5' },
                { title: 'Sports', artist: 'Beach Bunny', url: 'https://od.lk/s/OTdfOTQzODAzNzVf/Beach%20Bunny%20Sports%20Official%20Audio.mp3', albumArtUrl: 'https://t2.genius.com/unsafe/344x344/https%3A%2F%2Fimages.genius.com%2Fddaa4d18b3ce067a20f95d4a5a662819.1000x1000x1.jpg' },
                { title: 'Dream Space', artist: 'DVRST', url: 'https://od.lk/s/OTdfOTQ0MDA1NTJf/DVRST%20Dream%20Space.mp3', albumArtUrl: 'https://i1.sndcdn.com/artworks-xBF9BLLAysdb1WLv-oNF5eQ-t1080x1080.jpg' },
            ];

            function setupMusicPlayer() {
                let toastTimeout, isPlaylistToggling = false;
                const player = {
                    audio: document.getElementById('audio-player'),
                    playlist: [...playlistData],
                    originalPlaylist: [...playlistData],
                    favorites: JSON.parse(localStorage.getItem('oss_music_player_favorites') || '[]'),
                    currentTrack: 0, isPlaying: false, isShuffle: false,
                    repeatMode: 'none', // 'none', 'all', 'one'
                    sleepTimer: null, sleepTimerDuration: 0,
                    audioContext: null, sourceNode: null, analyserNode: null, dataArray: null,
                    dom: {
                        player: document.getElementById('music-player'), toggleBtn: document.getElementById('player-toggle-btn'),
                        playPauseBtn: document.getElementById('play-pause-btn'), nextBtn: document.getElementById('next-btn'),
                        prevBtn: document.getElementById('prev-btn'), shuffleBtn: document.getElementById('shuffle-btn'),
                        repeatBtn: document.getElementById('repeat-btn'), likeBtn: document.getElementById('like-btn'),
                        sleepTimerBtn: document.getElementById('sleep-timer-btn'),
                        timelineSlider: document.getElementById('timeline-slider'),
                        songTitleEl: document.getElementById('song-title'), songArtistEl: document.getElementById('song-artist'),
                        albumArt: document.getElementById('album-art'), albumBg: document.getElementById('player-album-bg'),
                        toast: document.getElementById('song-notification-toast'), toastArt: document.getElementById('toast-album-art'),
                        toastTitle: document.getElementById('toast-song-title'), volumeBtn: document.getElementById('volume-btn'),
                        volumeSlider: document.getElementById('volume-slider-input'), playlistBtn: document.getElementById('playlist-btn'),
                        playlistToggleBtnMain: document.getElementById('playlist-toggle-btn-main'),
                        playlistModal: document.getElementById('playlist-modal'), playlistContainer: document.getElementById('playlist-container'),
                        playlistSearch: document.getElementById('playlist-search'), filterFavBtn: document.getElementById('filter-fav-btn'),
                        currentTimeEl: document.getElementById('current-time'), totalDurationEl: document.getElementById('total-duration'),
                        themeSwitcher: document.getElementById('theme-switcher'), promoBanner: document.getElementById('github-promotion'),
                        promoLink: document.getElementById('github-link'), promoCloseBtn: document.getElementById('close-promo-btn'),
                        playerBody: document.querySelector('.player-body')
                    }
                };
                
                // Create canvas element dynamically
                const visualizerCanvas = document.createElement('canvas');
                visualizerCanvas.id = 'visualizer';
                player.dom.visualizerCanvas = visualizerCanvas;


                let lastBarHeights = [];
                let animationFrameId;
                
                function applyTheme(themeName) {
                    const theme = playerConfig.themes[themeName]; if (!theme) return;
                    for (const [key, value] of Object.entries(theme)) if (key !== 'name') document.documentElement.style.setProperty(key, value);
                    localStorage.setItem('oss_music_player_theme', themeName);
                    if(player.dom.themeSwitcher){
                        const currentActive = player.dom.themeSwitcher.querySelector('.active');
                        if (currentActive) currentActive.classList.remove('active');
                        const newActive = player.dom.themeSwitcher.querySelector(`[data-theme="${themeName}"]`);
                        if (newActive) newActive.classList.add('active');
                    }
                    // Force redraw of visualizer to pick up new colors immediately
                    if (player.isPlaying) {
                        cancelAnimationFrame(animationFrameId);
                        drawVisualizer();
                    }
                }
                
                function setupThemeSwitcher() {
                    if (!player.dom.themeSwitcher) return;
                    player.dom.themeSwitcher.innerHTML = '';
                    for(const [key, theme] of Object.entries(playerConfig.themes)) {
                        const button = document.createElement('button');
                        button.className = 'theme-button'; 
                        button.dataset.theme = key; 
                        button.title = theme.name;
                        button.style.backgroundColor = theme['--highlight-color'];
                        button.addEventListener('click', () => applyTheme(key));
                        player.dom.themeSwitcher.appendChild(button);
                    }
                }
                
                function setupPromotion() {
                    if(player.dom.promoLink) player.dom.promoLink.href = `https://github.com/${playerConfig.githubUsername}/modern-html5-music-player`;
                    if (player.dom.promoBanner) {
                         if (!playerConfig.promotionEnabled || localStorage.getItem('oss_music_player_promo_seen') === 'true') player.dom.promoBanner.classList.add('hidden');
                    }
                    if (player.dom.promoCloseBtn) {
                        player.dom.promoCloseBtn.addEventListener('click', () => {
                            if(player.dom.promoBanner) player.dom.promoBanner.classList.add('hidden');
                            localStorage.setItem('oss_music_player_promo_seen', 'true');
                        });
                    }
                }

                function initAudioContext() {
                    if (player.audioContext) return;
                    try {
                        player.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        player.sourceNode = player.audioContext.createMediaElementSource(player.audio);
                        player.analyserNode = player.audioContext.createAnalyser();
                        player.analyserNode.fftSize = 256;
                        player.sourceNode.connect(player.analyserNode);
                        player.analyserNode.connect(player.audioContext.destination);
                        player.dataArray = new Uint8Array(player.analyserNode.frequencyBinCount);
                        drawVisualizer();
                    } catch (e) { console.error("Web Audio API is not supported.", e); }
                }
                // Try to init on any click if not started
                document.addEventListener('click', initAudioContext, { once: true });
                
                function drawVisualizer() {
                    animationFrameId = requestAnimationFrame(drawVisualizer);
                
                    if (!player.analyserNode) return;
                
                    const canvas = player.dom.visualizerCanvas;
                    if(!canvas) return;

                    const ctx = canvas.getContext('2d');
                    // Ensure canvas size matches parent
                    if (canvas.parentElement && (canvas.width !== canvas.parentElement.offsetWidth || canvas.height !== canvas.parentElement.offsetHeight)) {
                        canvas.width = canvas.parentElement.offsetWidth;
                        canvas.height = canvas.parentElement.offsetHeight;
                    }
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                    const bufferLength = player.analyserNode.frequencyBinCount;
                    if (lastBarHeights.length !== bufferLength) {
                        lastBarHeights = new Array(bufferLength).fill(0);
                    }
                    
                    const style = getComputedStyle(document.documentElement);
                    const highlightColor = style.getPropertyValue('--highlight-color').trim();
                    const primaryColor = style.getPropertyValue('--primary-text').trim();

                    const time = Date.now() * 0.001;
                    const xOffset = Math.sin(time / 2) * canvas.width * 0.5;
                    const gradient = ctx.createLinearGradient(xOffset, 0, canvas.width - xOffset, 0);
                    gradient.addColorStop(0, highlightColor);
                    gradient.addColorStop(1, primaryColor);
                
                    let targetFrequencies = new Uint8Array(bufferLength);
                    if (player.isPlaying) {
                        player.analyserNode.getByteFrequencyData(targetFrequencies);
                    }
                
                    let barWidth;
                    // Check if visualizer is in the small button or the main player body
                    if (player.dom.toggleBtn && canvas.parentElement === player.dom.toggleBtn) {
                        barWidth = (canvas.width / bufferLength) * 2.5; 
                    } else {
                        barWidth = (canvas.width / bufferLength) * 1.5; 
                    }

                    let x = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        let targetHeight = (targetFrequencies[i] / 255) * canvas.height * 0.8;
                        let currentHeight = lastBarHeights[i] || 0;
                
                        if (currentHeight < targetHeight) {
                            currentHeight += (targetHeight - currentHeight) * 0.2;
                        } else {
                            currentHeight = currentHeight * 0.95;
                        }
                
                        if (currentHeight < 1) currentHeight = 0;
                        lastBarHeights[i] = currentHeight;
                
                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, canvas.height - currentHeight, barWidth, currentHeight);
                        x += barWidth + 1;
                    }
                }

                function showToast(title, message) {
                    if (!player.dom.toast) return;
                    clearTimeout(toastTimeout);
                    // Use a generic placeholder if no art is applicable, or the current song's art
                    if(player.dom.toastArt) {
                        player.dom.toastArt.src = player.playlist[player.currentTrack]?.albumArtUrl || '';
                        player.dom.toastArt.style.display = message ? 'none' : 'block';
                    }
                    // Re-use notification toast for generic messages
                    const toastDiv = player.dom.toast.querySelector('div');
                    if(toastDiv && toastDiv.firstElementChild) toastDiv.firstElementChild.textContent = title;
                    if(player.dom.toastTitle) player.dom.toastTitle.textContent = message || '';
                    
                    player.dom.toast.classList.add('show');
                    toastTimeout = setTimeout(() => {
                        player.dom.toast.classList.remove('show');
                        // Reset for song notifications
                        setTimeout(() => { if(player.dom.toastArt) player.dom.toastArt.style.display = 'block'; }, 300);
                    }, 3000);
                }

                function showSongToast(track) {
                    if(!player.dom.toast) return;
                    clearTimeout(toastTimeout);
                    if(player.dom.toastArt) {
                        player.dom.toastArt.style.display = 'block';
                        player.dom.toastArt.src = track.albumArtUrl;
                    }
                    const toastDiv = player.dom.toast.querySelector('div');
                    if(toastDiv && toastDiv.firstElementChild) toastDiv.firstElementChild.textContent = 'Now Playing:';
                    if(player.dom.toastTitle) player.dom.toastTitle.textContent = track.title;
                    player.dom.toast.classList.add('show');
                    toastTimeout = setTimeout(() => player.dom.toast.classList.remove('show'), 4000);
                }

                function updateMediaSession(track) {
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: track.title,
                            artist: track.artist,
                            album: 'Pekly\'s Music Player',
                            artwork: [{ src: track.albumArtUrl, sizes: '512x512', type: 'image/jpeg' }]
                        });
                    }
                }

                function isFavorite(url) {
                    return player.favorites.includes(url);
                }

                function toggleFavorite(url) {
                    if (isFavorite(url)) {
                        player.favorites = player.favorites.filter(u => u !== url);
                    } else {
                        player.favorites.push(url);
                    }
                    localStorage.setItem('oss_music_player_favorites', JSON.stringify(player.favorites));
                    updateLikeBtn();
                    // If filter is active, refresh the list
                    if (player.dom.filterFavBtn && player.dom.filterFavBtn.classList.contains('active')) {
                         const searchTerm = player.dom.playlistSearch ? player.dom.playlistSearch.value.toLowerCase() : '';
                        const filteredSongs = player.playlist.filter(song => {
                            const matchesSearch = song.title.toLowerCase().includes(searchTerm) || song.artist.toLowerCase().includes(searchTerm);
                            return matchesSearch && isFavorite(song.url);
                        });
                        populatePlaylistModal(filteredSongs);
                    } else {
                        populatePlaylistModal(player.playlist); // Refresh just icons
                    }
                }

                function updateLikeBtn() {
                    if (!player.dom.likeBtn) return;
                    const currentSong = player.playlist[player.currentTrack];
                    const isFav = isFavorite(currentSong.url);
                    if (isFav) {
                        player.dom.likeBtn.classList.add('liked');
                        player.dom.likeBtn.innerHTML = '<i class="fas fa-heart"></i>';
                    } else {
                        player.dom.likeBtn.classList.remove('liked');
                        player.dom.likeBtn.innerHTML = '<i class="far fa-heart"></i>';
                    }
                }

                function loadTrack(trackIndex, shouldPlay = false) {
                    // Update playing class in playlist
                    const oldPlaying = player.dom.playlistContainer.querySelector('.playlist-song.playing');
                    if (oldPlaying) {
                        oldPlaying.classList.remove('playing');
                        const img = oldPlaying.querySelector('img');
                        if (img) img.classList.remove('spinning');
                    }

                    player.currentTrack = trackIndex;
                    localStorage.setItem('oss_music_player_currentTrack', trackIndex);
                    const track = player.playlist[trackIndex];
                    if(player.dom.songTitleEl) player.dom.songTitleEl.textContent = track.title;
                    if(player.dom.songArtistEl) player.dom.songArtistEl.textContent = track.artist;
                    if(player.dom.albumArt) player.dom.albumArt.src = track.albumArtUrl;
                    if(player.dom.albumBg) player.dom.albumBg.style.backgroundImage = `url(${track.albumArtUrl})`;
                    if(player.dom.timelineSlider) player.dom.timelineSlider.value = 0;
                    if (player.audio.src !== track.url) player.audio.src = track.url;
                    if (player.dom.player.classList.contains('player-hidden') && shouldPlay) showSongToast(track);
                    player.audio.load();
                    updateLikeBtn(); // Update heart for new song
                    
                    if(shouldPlay) {
                        if (player.audioContext && player.audioContext.state === 'suspended') player.audioContext.resume();
                        player.audio.play().catch(e => console.log("Playback was prevented: ", e.message));
                    }
                    updateMediaSession(track);
                    populatePlaylistModal();
                };
                
                function formatTime(seconds) {
                    if (isNaN(seconds) || seconds < 0) return "0:00";
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                }

                const playNext = () => loadTrack((player.currentTrack + 1) % player.playlist.length, true);
                const playPrevious = () => loadTrack((player.currentTrack - 1 + player.playlist.length) % player.playlist.length, true);
                const togglePlay = () => {
                    if (player.audioContext && player.audioContext.state === 'suspended') player.audioContext.resume();
                    if (player.audio.paused) player.audio.play().catch(e => console.error("Playback failed:", e));
                    else player.audio.pause();
                };

                if (player.dom.toggleBtn) {
                    player.dom.toggleBtn.addEventListener('click', () => {
                        const isHidden = player.dom.player.classList.toggle('player-hidden');
                        if (isHidden) {
                            player.dom.toggleBtn.appendChild(player.dom.visualizerCanvas);
                        } else {
                            player.dom.playerBody.insertBefore(player.dom.visualizerCanvas, player.dom.playerBody.firstChild);
                        }
                    });
                }
                
                if(player.dom.playPauseBtn) player.dom.playPauseBtn.addEventListener('click', togglePlay);
                if(player.dom.likeBtn) player.dom.likeBtn.addEventListener('click', () => toggleFavorite(player.playlist[player.currentTrack].url));

                // Sleep Timer Logic
                if (player.dom.sleepTimerBtn) {
                    player.dom.sleepTimerBtn.addEventListener('click', () => {
                        if (player.sleepTimer) { clearTimeout(player.sleepTimer); player.sleepTimer = null; }
                        
                        // Cycle: 0 -> 15 -> 30 -> 60 -> 0
                        if (player.sleepTimerDuration === 0) player.sleepTimerDuration = 15;
                        else if (player.sleepTimerDuration === 15) player.sleepTimerDuration = 30;
                        else if (player.sleepTimerDuration === 30) player.sleepTimerDuration = 60;
                        else player.sleepTimerDuration = 0;

                        if (player.sleepTimerDuration > 0) {
                            player.dom.sleepTimerBtn.classList.add('active');
                            player.sleepTimer = setTimeout(() => {
                                if (!player.audio.paused) togglePlay();
                                player.sleepTimerDuration = 0;
                                player.dom.sleepTimerBtn.classList.remove('active');
                                showToast("Sleep Timer", "Music stopped by timer.");
                            }, player.sleepTimerDuration * 60 * 1000);
                            showToast("Sleep Timer", `Set for ${player.sleepTimerDuration} minutes`);
                        } else {
                            player.dom.sleepTimerBtn.classList.remove('active');
                            showToast("Sleep Timer", "Timer turned off");
                        }
                    });
                }

                player.audio.addEventListener('play', () => {
                    player.isPlaying = true;
                    if(player.dom.playPauseBtn) {
                        player.dom.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        player.dom.playPauseBtn.setAttribute('aria-pressed', 'true');
                    }
                    if(player.dom.albumArt) player.dom.albumArt.classList.add('spinning');
                    if(player.dom.playlistContainer && player.dom.playlistContainer.children[player.currentTrack]) {
                        const playingRow = player.dom.playlistContainer.children[player.currentTrack];
                        if (playingRow) {
                            const playingImg = playingRow.querySelector('img');
                            if (playingImg) playingImg.classList.add('spinning');
                        }
                    }
                    navigator.mediaSession.playbackState = 'playing';
                });
                player.audio.addEventListener('pause', () => {
                    player.isPlaying = false;
                    if(player.dom.playPauseBtn) {
                        player.dom.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        player.dom.playPauseBtn.setAttribute('aria-pressed', 'false');
                    }
                    if(player.dom.albumArt) player.dom.albumArt.classList.remove('spinning');
                    if(player.dom.playlistContainer && player.dom.playlistContainer.children[player.currentTrack]) {
                        const playingRow = player.dom.playlistContainer.children[player.currentTrack];
                        if (playingRow) {
                            const playingImg = playingRow.querySelector('img');
                            if (playingImg) playingImg.classList.remove('spinning');
                        }
                    }
                    navigator.mediaSession.playbackState = 'paused';
                });
                
                player.audio.addEventListener('waiting', () => { if(player.dom.player) player.dom.player.classList.add('buffering'); });
                player.audio.addEventListener('playing', () => { if(player.dom.player) player.dom.player.classList.remove('buffering'); });
                player.audio.addEventListener('canplay', () => { if(player.dom.player) player.dom.player.classList.remove('buffering'); });

                if(player.dom.nextBtn) player.dom.nextBtn.addEventListener('click', playNext);
                if(player.dom.prevBtn) player.dom.prevBtn.addEventListener('click', playPrevious);

                player.audio.addEventListener('ended', () => {
                    if (player.repeatMode === 'one') { player.audio.currentTime = 0; player.audio.play(); } 
                    else if (player.currentTrack === player.playlist.length - 1 && player.repeatMode !== 'all') { /* Do nothing, stop */ } 
                    else { playNext(); }
                });
                
                player.audio.addEventListener('loadedmetadata', () => { if(player.dom.totalDurationEl) player.dom.totalDurationEl.textContent = formatTime(player.audio.duration); });
                player.audio.addEventListener('timeupdate', () => {
                    if (player.audio.duration) {
                        if(player.dom.timelineSlider) player.dom.timelineSlider.value = (player.audio.currentTime / player.audio.duration) * 100;
                        if(player.dom.currentTimeEl) player.dom.currentTimeEl.textContent = formatTime(player.audio.currentTime);
                    }
                });
                if(player.dom.timelineSlider) {
                    player.dom.timelineSlider.addEventListener('input', (e) => { if (player.audio.duration) player.audio.currentTime = (e.target.value / 100) * player.audio.duration; });
                    player.dom.timelineSlider.addEventListener('mousedown', () => player.dom.timelineSlider.classList.add('grabbing'));
                    player.dom.timelineSlider.addEventListener('mouseup', () => player.dom.timelineSlider.classList.remove('grabbing'));
                }

                if(player.dom.shuffleBtn) {
                    player.dom.shuffleBtn.addEventListener('click', () => {
                        player.isShuffle = !player.isShuffle;
                        player.dom.shuffleBtn.setAttribute('aria-pressed', player.isShuffle);
                        localStorage.setItem('oss_music_player_isShuffle', player.isShuffle);
                        player.dom.shuffleBtn.classList.toggle('toggled-glow', player.isShuffle);
                        const currentSongUrl = player.playlist[player.currentTrack]?.url;
                        if (player.isShuffle) {
                            let shuffled = [...player.originalPlaylist];
                            for (let i = shuffled.length - 1; i > 0; i--) { [shuffled[i], shuffled[Math.floor(Math.random() * (i + 1))]] = [shuffled[Math.floor(Math.random() * (i + 1))], shuffled[i]]; }
                            player.playlist = shuffled;
                        } else { player.playlist = [...player.originalPlaylist]; }
                        player.currentTrack = player.playlist.findIndex(track => track.url === currentSongUrl);
                        if (player.currentTrack === -1) player.currentTrack = 0;
                        populatePlaylistModal();
                    });
                }

                if(player.dom.repeatBtn) {
                    player.dom.repeatBtn.addEventListener('click', () => {
                        if (player.repeatMode === 'none') { // --> REPEAT ONE
                            player.repeatMode = 'one';
                            player.dom.repeatBtn.classList.add('toggled-glow');
                            player.dom.repeatBtn.classList.add('repeat-one-active');
                            player.dom.repeatBtn.setAttribute('aria-pressed', 'true');
                        } else if (player.repeatMode === 'one') { // --> REPEAT ALL
                            player.repeatMode = 'all';
                            player.dom.repeatBtn.classList.remove('repeat-one-active');
                        } else { // --> REPEAT OFF
                            player.repeatMode = 'none';
                            player.dom.repeatBtn.classList.remove('toggled-glow', 'repeat-one-active');
                            player.dom.repeatBtn.setAttribute('aria-pressed', 'false');
                        }
                        localStorage.setItem('oss_music_player_repeatMode', player.repeatMode);
                    });
                }

                if(player.dom.volumeSlider) player.dom.volumeSlider.addEventListener('input', (e) => { player.audio.volume = e.target.value; localStorage.setItem('oss_music_player_volume', e.target.value); });
                player.audio.addEventListener('volumechange', () => {
                    if(!player.dom.volumeBtn) return;
                    const icon = player.dom.volumeBtn.querySelector('i');
                    if(!icon) return;
                    if (player.audio.volume > 0.5) icon.className = 'fas fa-volume-up';
                    else if (player.audio.volume > 0) icon.className = 'fas fa-volume-down';
                    else icon.className = 'fas fa-volume-mute';
                });

                function togglePlaylistModal() {
                    if (isPlaylistToggling) return;
                    if (!player.dom.playlistModal) return;
                    isPlaylistToggling = true;
                    const isOpening = !player.dom.playlistModal.classList.contains('show');
                    if (isOpening && localStorage.getItem('oss_music_player_promo_seen') !== 'true') localStorage.setItem('oss_music_player_promo_seen', 'true');
                    player.dom.playlistModal.classList.toggle('show');
                    setTimeout(() => isPlaylistToggling = false, 400);
                }

                function populatePlaylistModal(songsToDisplay = player.playlist) {
                    if(!player.dom.playlistContainer) return;
                    player.dom.playlistContainer.innerHTML = '';
                    songsToDisplay.forEach((song) => {
                        const originalIndex = player.playlist.findIndex(pSong => pSong.url === song.url);
                        const songEl = document.createElement('div');
                        songEl.className = 'playlist-song';
                        if(originalIndex === player.currentTrack) songEl.classList.add('playing');
                        
                        // Heart icon logic for playlist item
                        const isFav = isFavorite(song.url);
                        const favClass = isFav ? 'active' : '';
                        const favIcon = isFav ? 'fas fa-heart' : 'far fa-heart';
                        
                        songEl.innerHTML = `
                            <img src="${song.albumArtUrl}" alt="${song.title} album art">
                            <div><div class="playlist-song-title">${song.title}</div><div class="playlist-song-artist">${song.artist}</div></div>
                            <i class="${favIcon} fav-icon ${favClass}"></i>
                        `;
                        
                        // Handle click on the row (play) vs click on heart
                        songEl.addEventListener('click', (e) => {
                            if (e.target.classList.contains('fav-icon')) {
                                e.stopPropagation();
                                toggleFavorite(song.url);
                            } else {
                                loadTrack(originalIndex, true); 
                                if(player.dom.playlistModal && player.dom.playlistModal.classList.contains('show')) togglePlaylistModal();
                            }
                        });
                        
                        player.dom.playlistContainer.appendChild(songEl);
                    });
                    if (player.isPlaying) {
                        const playingImg = player.dom.playlistContainer.querySelector('.playlist-song.playing img');
                        if (playingImg) playingImg.classList.add('spinning');
                    }
                }
                
                if(player.dom.playlistBtn) player.dom.playlistBtn.addEventListener('click', togglePlaylistModal);
                if(player.dom.playlistToggleBtnMain) player.dom.playlistToggleBtnMain.addEventListener('click', togglePlaylistModal);
                if(player.dom.playlistModal) {
                    const closeBtn = player.dom.playlistModal.querySelector('.modal-close-btn');
                    if(closeBtn) closeBtn.addEventListener('click', togglePlaylistModal);
                }
                
                // Search & Filter Logic
                const filterPlaylist = () => {
                    if(!player.dom.playlistSearch) return;
                    const searchTerm = player.dom.playlistSearch.value.toLowerCase();
                    const showFavsOnly = player.dom.filterFavBtn && player.dom.filterFavBtn.classList.contains('active');
                    
                    const filteredSongs = player.playlist.filter(song => {
                        const matchesSearch = song.title.toLowerCase().includes(searchTerm) || song.artist.toLowerCase().includes(searchTerm);
                        const matchesFav = showFavsOnly ? isFavorite(song.url) : true;
                        return matchesSearch && matchesFav;
                    });
                    populatePlaylistModal(filteredSongs);
                };

                if(player.dom.playlistSearch) player.dom.playlistSearch.addEventListener('input', filterPlaylist);
                
                if(player.dom.filterFavBtn) {
                    player.dom.filterFavBtn.addEventListener('click', () => {
                        player.dom.filterFavBtn.classList.toggle('active');
                        filterPlaylist();
                    });
                }

                document.addEventListener('click', (e) => {
                    if (player.dom.playlistModal && player.dom.playlistModal.classList.contains('show')) {
                        const modalContent = player.dom.playlistModal.querySelector('.modal-content');
                        if(modalContent && !modalContent.contains(e.target) && !e.target.closest('.album-art-container') && !e.target.closest('#playlist-toggle-btn-main')) {
                            togglePlaylistModal();
                        }
                    }
                });
                
                function setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        if (e.target.tagName === 'INPUT') return;
                        
                        switch(e.code) {
                            case 'Space':
                                e.preventDefault();
                                togglePlay();
                                break;
                            case 'ArrowRight':
                                playNext();
                                break;
                            case 'ArrowLeft':
                                playPrevious();
                                break;
                            case 'KeyM':
                                player.audio.muted = !player.audio.muted;
                                break;
                        }
                    });
                }

                function setupMediaSession() {
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.setActionHandler('play', togglePlay);
                        navigator.mediaSession.setActionHandler('pause', togglePlay);
                        navigator.mediaSession.setActionHandler('nexttrack', playNext);
                        navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
                    }
                }
                
                function initializePlayer() {
                    // Set initial visualizer position
                    if(player.dom.toggleBtn && player.dom.visualizerCanvas) player.dom.toggleBtn.appendChild(player.dom.visualizerCanvas);

                    setupThemeSwitcher();
                    setupPromotion();
                    applyTheme(localStorage.getItem('oss_music_player_theme') || playerConfig.defaultTheme);
                    const savedShuffle = localStorage.getItem('oss_music_player_isShuffle') === 'true';
                    const savedVolume = parseFloat(localStorage.getItem('oss_music_player_volume')) || 0.2;
                    const savedRepeatMode = localStorage.getItem('oss_music_player_repeatMode') || 'none';

                    player.audio.volume = savedVolume;
                    if(player.dom.volumeSlider) player.dom.volumeSlider.value = savedVolume;
                    player.repeatMode = savedRepeatMode;
                    if(player.dom.repeatBtn) {
                        if(player.repeatMode === 'all') { player.dom.repeatBtn.classList.add('toggled-glow'); player.dom.repeatBtn.setAttribute('aria-pressed', 'true'); }
                        else if (player.repeatMode === 'one') { player.dom.repeatBtn.classList.add('toggled-glow', 'repeat-one-active'); player.dom.repeatBtn.setAttribute('aria-pressed', 'true'); }
                    }
                    if(savedShuffle && player.dom.shuffleBtn) player.dom.shuffleBtn.click();
                    const savedTrack = parseInt(localStorage.getItem('oss_music_player_currentTrack'), 10) || 0;
                    loadTrack(savedTrack > 0 && savedTrack < player.playlist.length ? savedTrack : 0);
                    
                    setupKeyboardShortcuts();
                    setupMediaSession();
                    document.body.classList.remove('loading');
                }
                initializePlayer();
            }
            setupMusicPlayer();
        });
    </script>
</body>
</html>
